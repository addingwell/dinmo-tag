___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Dinmo",
  "brand": {
    "id": "brand_dummy",
    "displayName": "Addingwell",
    "thumbnail": "data:image/jpeg;base64,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"
  },
  "description": "Insert GA4 incoming requests into a BigQuery table.\n\nPrerequisites\n\n- A Google Cloud project with BigQuery enabled.\n- A configured GTM server-side tagging environment.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "bqProjectId",
    "displayName": "BigQuery project id",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "bqDatasetId",
    "displayName": "BigQuery Dataset id",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "bqTableId",
    "displayName": "BigQuery table id",
    "simpleValueType": true,
    "alwaysInSummary": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "excludeParams",
    "displayName": "Exclude parameters",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "key",
        "name": "key",
        "type": "TEXT"
      }
    ],
    "alwaysInSummary": true
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "updateParams",
    "displayName": "Add / Modify parameters",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "key",
        "name": "key",
        "type": "TEXT"
      },
      {
        "defaultValue": "",
        "displayName": "value",
        "name": "value",
        "type": "TEXT"
      }
    ],
    "alwaysInSummary": true
  }
]


___SANDBOXED_JS_FOR_SERVER___

const BigQuery = require("BigQuery");
const getAllEventData = require("getAllEventData");
const getContainerVersion = require('getContainerVersion');
const logToConsole = require("logToConsole");
const JSON = require("JSON");
const Object = require('Object');
const makeNumber = require('makeNumber');
const makeString = require('makeString');
const getRemoteAddress = require('getRemoteAddress');
const getRequestHeader = require('getRequestHeader');
const getTimestampMillis = require('getTimestampMillis');
const parseUrl = require('parseUrl');
const sha256Sync = require('sha256Sync');
const getType = require('getType');

const isLoggingEnabled = determinateIsLoggingEnabled();
const traceId = isLoggingEnabled ? getRequestHeader('trace-id') : undefined;

const eventData = getAllEventData();

const rowEventData = eventData;

const event_timestamp = getTimestampMillis() / 1000;
const user_agent = getRequestHeader('user-agent');
const ip_address = getRemoteAddress();

// Set BQ connection info
const connectionInfo = {
    'projectId': data.bqProjectId,
    'datasetId': data.bqDatasetId,
    'tableId': data.bqTableId
};

const options = {
    'ignoreUnknownValues': true,
    'skipInvalidRows': false
};

const acceptedXGaKeys = [
    "x-ga-measurement_id",
    "x-ga-protocol_version",
    "x-ga-gcs",
    "x-ga-gcd",
    "x-ga-dma",
    "x-ga-dma_cps"
];

const topDbFields = [
    "ga_session_id",
    "ga_session_number",
    "client_id",
    "language",
    "screen_resolution",
    "page_title",
    "page_location",
    "page_referrer",
    "event_name",
    "engagement_time_msec",
    "items",
    "transaction_id",
    "value",
    "currency",
    "user_id",
];

const itemsFields = [
    "item_id",
    "item_name",
    "item_brand",
    "item_variant",
    "item_category",
    "item_category2",
    "item_category3",
    "item_category4",
    "item_category5",
    "price",
    "quantity",
    "item_refund",
    "coupon",
    "affiliation",
    "location_id",
    "item_list_id",
    "item_list_name",
    "index",
    "promotion_id",
    "promotion_name",
    "creative_name",
    "creative_slot",
    "discount",
    "currency",
];

const excludedEventParams = [
    "client_hints",
    "ip_override",
    "user_agent",
    "x-sst-system_properties"
];

let rowSlave = {};
rowSlave.event_timestamp = event_timestamp;
rowSlave.user_agent = user_agent;
rowSlave.ip_address = ip_address;
rowSlave.session_engagement = rowEventData["x-ga-mp2-seg"];
rowSlave.event_params = [];
rowSlave = buildRowSlave(rowSlave);

const urlObject = parseUrl(rowEventData.page_location);
const pageLocationParameters = urlObject.searchParams;
rowSlave.page_location_params = buildKeyValueParams(pageLocationParameters);

if(rowEventData["x-ga-mp2-user_properties"]) {
    rowSlave.user_properties = buildKeyValueParams(rowEventData["x-ga-mp2-user_properties"]);
}

let rowFinal = excludeParamsRow(rowSlave);
rowFinal = editOrAddParamsRow(rowFinal);

if (isLoggingEnabled) {
    logToConsole(JSON.stringify({
        'Name': 'BigQuery',
        'Type': 'Rows',
        'TraceId': traceId,
        'Rows': [rowFinal],
    }));
}

BigQuery.insert(connectionInfo, [rowFinal], options)
    .then((success) => {
        data.gtmOnSuccess();
        logToConsole('success', [rowFinal]);
    }, (e) => {
        data.gtmOnFailure();
        logToConsole(JSON.stringify(e));
    });


function determinateIsLoggingEnabled() {
    const containerVersion = getContainerVersion();
    return !!(
        containerVersion &&
        (containerVersion.debugMode || containerVersion.previewMode)
    );
}

function isAlreadyHashed(input){
  return input && (input.toString().match('^[A-Fa-f0-9]{64}$') != null);
}

function hashData(input){
  if(input == null || isAlreadyHashed(input)){
    return input;
  }

  return sha256Sync(input.toString().trim().toLowerCase(), {outputEncoding: 'hex'});
}

function buildRowSlave(rowSlave) {
    for (const rowEntry of Object.entries(rowEventData)) {
        let key = rowEntry[0];
        const value = rowEntry[1];

        if (key.indexOf('x-ga') !== -1 && acceptedXGaKeys.indexOf(key) === -1) {
            continue;
        }

        if (key.indexOf('x-ga') !== -1) {
            key = key.replace("x-ga-", "");
            rowSlave[key] = value;
        } else {
            if(key === 'user_data' && value) {
               let userDataValue = value;
               const typeUserData = getType(value);
               if(typeUserData === "array") {
                 userDataValue = value[0];
               }

               let userData = {
                   email_address: hashData((eventData.user_data != null) ? eventData.user_data.email_address || eventData.user_data.sha256_email_address || eventData.user_data.email : undefined),
                   phone_number: hashData((eventData.user_data != null) ? eventData.user_data.phone_number || eventData.user_data.sha256_phone_number : undefined),
               };
              
               const addressData = (eventData.user_data != null && eventData.user_data.address != null) ? (eventData.user_data.address[0] != null ? eventData.user_data.address[0] : eventData.user_data.address) : {};
               userData.first_name = hashData(addressData.first_name || addressData.sha256_first_name);
               userData.last_name = hashData(addressData.last_name || addressData.sha256_last_name);
               userData.city = hashData(addressData.city);
               userData.region = hashData(addressData.region);
               userData.street = hashData(addressData.street);
               userData.postal_code = hashData(addressData.postal_code);
               userData.country = hashData(addressData.country);

               rowSlave.user_data = userData;

            } else if (topDbFields.indexOf(key) !== -1) {
                if(key === 'items') {
                    rowSlave.items = getItems(value);
                } else {
                    rowSlave[key] = value;
                }
            } else if(excludedEventParams.indexOf(key) === -1){
                rowSlave.event_params.push({key: key, value: getTypeValue(value)});
            }
        }
    }

    return rowSlave;
}

function getItems(itemsRaw) {
    let items = [];
    for (let i = 0; i < itemsRaw.length; i += 1) {
        const itemRaw = itemsRaw[i];
        let item = {};
        for (let itemRawEntry of Object.entries(itemRaw)) {
            const itemRawKey = itemRawEntry[0];
            const itemRawValue = itemRawEntry[1];

            if(itemsFields.indexOf(itemRawKey) !== -1) {
                item[itemRawKey] = itemRawValue;
            }
        }
        items.push(item);
    }
    return items;
}

function buildKeyValueParams(params) {
    let keyValueParams = [];
    for (const userPropertyEntry of Object.entries(params)) {
        const key = userPropertyEntry[0];
        const value = userPropertyEntry[1];

        keyValueParams.push({key: key, value: getTypeValue(value)});
    }
    return keyValueParams;
}

function getTypeValue(value) {
    let valueObject = {};

    if(typeof value === 'object') {
        valueObject.object_value = JSON.stringify(value);
    } else if (makeNumber(value)) {
        valueObject.float_value = makeNumber(value);
    } else if (makeString(value)) {
        valueObject.string_value = makeString(value);
    }
    return valueObject;
}

function excludeParamsRow(insertRow) {
    if(data.excludeParams && data.excludeParams.length > 0) {
        let excludeParams = [];
        for (let param of data.excludeParams) {
            if (param.key) {
                excludeParams[param.key] = true;
            }
        }
        let insertRowFinal = {};
        for (const entry of Object.entries(insertRow)) {
            const key = entry[0];
            const value = entry[1];
            if (!excludeParams[key]) {
                insertRowFinal[key] = value;
            }
        }

        return insertRowFinal;
    }

    return insertRow;
}

function editOrAddParamsRow(insertRow) {
    if(data.updateParams && data.updateParams.length > 0) {
        for (const updateParam of data.updateParams) {
            const key = updateParam.key;
            const value = updateParam.value;

            if (insertRow.hasOwnProperty(key)) {
                insertRow[key] = value;
            } else {
                insertRow.event_params.push({key: key, value: getTypeValue(value)});
            }
        }
    }
    return insertRow;
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_bigquery",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedTables",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "datasetId"
                  },
                  {
                    "type": 1,
                    "string": "tableId"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 19/12/2024 14:46:22


